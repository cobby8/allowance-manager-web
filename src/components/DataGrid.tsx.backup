import { useState, useMemo } from 'react';
import type { Employee, SettlementData } from '../types';
import { Search, Eye, FileText, MapPin, Calendar, CheckCircle, AlertCircle, XCircle } from 'lucide-react';
import ImagePreview from './ImagePreview';
import { generateProofDocument } from '../utils/pdfGenerator';
import './DataGrid.css';

interface DataGridProps {
    data: (Employee | SettlementData)[];
    hasWorkRecords?: boolean;
}

export default function DataGrid({ data, hasWorkRecords = false }: DataGridProps) {
    // Type guard to check if data is SettlementData
    const isSettlementData = (item: Employee | SettlementData): item is SettlementData => {
        return hasWorkRecords && 'workRecords' in item;
    };
    const [filter, setFilter] = useState('');
    const [preview, setPreview] = useState<{ src: string; alt: string; isOpen: boolean }>({
        src: '',
        alt: '',
        isOpen: false,
    });
    const [generatingId, setGeneratingId] = useState<string | null>(null);
    const [locationFilter, setLocationFilter] = useState('');
    const [dateFilter, setDateFilter] = useState('');

    const locations = useMemo(() => {
        const locs = new Set(data.map(d => d.workPlace).filter(Boolean));
        return Array.from(locs).sort();
    }, [data]);

    const handleGeneratePdf = async (employee: Employee) => {
        try {
            setGeneratingId(employee.id);
            await generateProofDocument(employee);
        } catch (error) {
            console.error('Failed to generate PDF', error);
            const closePreview = () => {
                setPreview({ ...preview, isOpen: false });
            };

            return (
                <div className="data-grid-container">
                    <div className="filters-section">
                        <div className="filters-grid">
                            <div className="filter-group">
                                <label className="filter-label">
                                    <Search size={14} style={{ display: 'inline', marginRight: '4px' }} />
                                    Í≤ÄÏÉâ
                                </label>
                                <input
                                    type="text"
                                    placeholder="Ïù¥Î¶Ñ, Ï£ºÏÜå Í≤ÄÏÉâ..."
                                    value={filter}
                                    onChange={(e) => setFilter(e.target.value)}
                                    className="filter-input"
                                />
                            </div>

                            <div className="filter-group">
                                <label className="filter-label">
                                    <MapPin size={14} style={{ display: 'inline', marginRight: '4px' }} />
                                    ÏÜåÏÜç
                                </label>
                                <select
                                    value={locationFilter}
                                    onChange={(e) => setLocationFilter(e.target.value)}
                                    className="filter-select"
                                >
                                    <option value="">Ï†ÑÏ≤¥</option>
                                    {locations.map(loc => (
                                        <option key={loc} value={loc}>{loc}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label className="filter-label">
                                    <Calendar size={14} style={{ display: 'inline', marginRight: '4px' }} />
                                    ÎÇ†Ïßú
                                </label>
                                <input
                                    type="text"
                                    placeholder="YYYY-MM-DD"
                                    value={dateFilter}
                                    onChange={(e) => setDateFilter(e.target.value)}
                                    className="filter-input"
                                />
                            </div>
                        </div>
                    </div>

                    {filteredData.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">üîç</div>
                            <h3 className="empty-state-title">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                            <p className="empty-state-message">
                                Îã§Î•∏ Í≤ÄÏÉâÏñ¥ÎÇò ÌïÑÌÑ∞Î•º ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî
                            </p>
                        </div>
                    ) : (
                        <>
                            <div className="employees-grid">
                                {filteredData.map((employee) => (
                                    <div key={employee.id} className="employee-card">
                                        <div className="employee-header">
                                            <div>
                                                <h3 className="employee-name">{employee.name}</h3>
                                                <p className="employee-id">{employee.residentId}</p>
                                            </div>
                                            {isSettlementData(employee) && (
                                                <div>
                                                    {employee.matchStatus === 'matched' && (
                                                        <span style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px',
                                                            fontSize: '12px',
                                                            color: 'var(--color-success)',
                                                            fontWeight: 600
                                                        }}>
                                                            <CheckCircle size={16} /> Îß§Ïπ≠Îê®
                                                        </span>
                                                    )}
                                                    {employee.matchStatus === 'partial' && (
                                                        <span style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px',
                                                            fontSize: '12px',
                                                            color: 'var(--color-warning)',
                                                            fontWeight: 600
                                                        }}>
                                                            <AlertCircle size={16} /> Î∂ÄÎ∂ÑÎß§Ïπ≠
                                                        </span>
                                                    )}
                                                    {employee.matchStatus === 'unmatched' && (
                                                        <span style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px',
                                                            fontSize: '12px',
                                                            color: 'var(--color-gray-500)',
                                                            fontWeight: 600
                                                        }}>
                                                            <XCircle size={16} /> ÎØ∏Îß§Ïπ≠
                                                        </span>
                                                    )}
                                                </div>
                                            )}
                                        </div>

                                        <div className="employee-info">
                                            <div className="info-row">
                                                <span className="info-label">Ïó∞ÎùΩÏ≤ò</span>
                                                <span className="info-value">{employee.address || '-'}</span>
                                            </div>
                                            <div className="info-row">
                                                <span className="info-label">ÏÜåÏÜç</span>
                                                <span className="info-value">{employee.workPlace || '-'}</span>
                                            </div>
                                            <div className="info-row">
                                                <span className="info-label">ÏùÄÌñâ</span>
                                                <span className="info-value">{employee.bankName || '-'}</span>
                                            </div>
                                            <div className="info-row">
                                                <span className="info-label">Í≥ÑÏ¢åÎ≤àÌò∏</span>
                                                <span className="info-value">{employee.accountNumber || '-'}</span>
                                            </div>

                                            {isSettlementData(employee) && employee.workRecords.length > 0 && (
                                                <>
                                                    <div style={{
                                                        borderTop: '1px solid var(--color-gray-200)',
                                                        marginTop: 'var(--spacing-md)',
                                                        paddingTop: 'var(--spacing-md)'
                                                    }}>
                                                        <div className="info-row">
                                                            <span className="info-label">Í∑ºÎ¨¥ÏùºÏàò</span>
                                                            <span className="info-value">{employee.workRecords.length}Ïùº</span>
                                                        </div>
                                                        <div className="info-row">
                                                            <span className="info-label">Ï¥ù ÏßÄÍ∏âÏï°</span>
                                                            <span className="info-value" style={{ fontWeight: 700, color: 'var(--color-primary)' }}>
                                                                {employee.totalGrossAmount.toLocaleString()}Ïõê
                                                            </span>
                                                        </div>
                                                        <div className="info-row">
                                                            <span className="info-label">Ïã§ÏàòÎ†πÏï°</span>
                                                            <span className="info-value" style={{ fontWeight: 700 }}>
                                                                {employee.totalNetAmount.toLocaleString()}Ïõê
                                                            </span>
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </div>

                                        {(employee.idCardImage || employee.bankBookImage || employee.licenseImage) && (
                                            <div className="employee-documents">
                                                {employee.idCardImage && (
                                                    <button
                                                        onClick={() => openPreview(employee.idCardImage, 'Ïã†Î∂ÑÏ¶ù')}
                                                        className="doc-badge"
                                                    >
                                                        <Eye size={12} /> Ïã†Î∂ÑÏ¶ù
                                                    </button>
                                                )}
                                                {employee.bankBookImage && (
                                                    <button
                                                        onClick={() => openPreview(employee.bankBookImage, 'ÌÜµÏû•ÏÇ¨Î≥∏')}
                                                        className="doc-badge"
                                                    >
                                                        <Eye size={12} /> ÌÜµÏû•ÏÇ¨Î≥∏
                                                    </button>
                                                )}
                                                {employee.licenseImage && (
                                                    <button
                                                        onClick={() => openPreview(employee.licenseImage, 'ÏûêÍ≤©Ï¶ù')}
                                                        className="doc-badge"
                                                    >
                                                        <Eye size={12} /> ÏûêÍ≤©Ï¶ù
                                                    </button>
                                                )}
                                            </div>
                                        )}

                                        <div className="employee-actions">
                                            <button
                                                className="btn-pdf"
                                                onClick={() => handleGeneratePdf(employee)}
                                                disabled={generatingId === employee.id}
                                            >
                                                {generatingId === employee.id ? (
                                                    <>
                                                        <div className="pdf-spinner" />
                                                        ÏÉùÏÑ± Ï§ë...
                                                    </>
                                                ) : (
                                                    <>
                                                        <FileText size={16} />
                                                        Î™ÖÏÑ∏ÏÑú ÏÉùÏÑ±
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <p className="results-count">
                                Ï¥ù <strong>{filteredData.length}</strong>Î™Ö / {data.length}Î™Ö
                            </p>
                        </>
                    )}

                    <ImagePreview
                        src={preview.src}
                        alt={preview.alt}
                        isOpen={preview.isOpen}
                        onClose={closePreview}
                    />
                </div>
            );
        }
